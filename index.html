<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Indonesia</title>
  <script src="jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="ramda.js" type="text/javascript" charset="utf-8"></script>
  <style>
    svg .region:hover {
      fill: red;
    }
  </style>
  <script>

    var s = (function(){
      var svgns = "http://www.w3.org/2000/svg";

      function tag(name, ns){
        ns || (ns = {});
        return function(attrs){
          var el = document.createElementNS(svgns, name);
          $.each(attrs, function(key, value){
            ns[key] ? el.setAttributeNS(ns[key], key, value) : el.setAttribute(key, value);
          });
          return $(el);
        }
      }

      function bbox(el){
        return el.get(0).getBBox();
      }

      function coord(el){
        var b = bbox(el);
        return {x: b.x, y: b.y};
      }

      function center(el){
        var b = bbox(el);
        return {x: b.x + (b.width / 2), y: b.y + (b.height / 2)};
      }

      return {
        bbox:   bbox,
        center: center,
        coord:  coord,
        animate: tag('animate'),
        rect:   tag('rect'),
        circle: tag('circle'),
        use:    tag('use', {href: "http://www.w3.org/1999/xlink"})
      }
    })(), use = s.use;

    function getParts(el, name, upper){
      return R.reduce(function(list, n){
        var piece = '#' + name + '-' + n;
        var part = el.find(piece);
        return part.length === 0 ? list : list.concat([part]);
      }, [], R.range(1, (upper || 10) + 1));
    }

    function addPiece(el, href){
      var offset = 17.5;
      var c = s.center(el), x = c.x - offset, y = c.y - offset;
      return use({x: x, y: y, href: href});
    }

    function getElements(f, names){
      return R.reduce(function(obj, name){
        obj[name] = f(name);
        return obj;
      }, {}, names)
    }

    function piece(board){
      return function(name){
        return board.find("#" + name);
      }
    }

    function pieces(board){
      return function(name){
        return getParts(board, name);
      }
    }

    function cycles(list){
      return function at(idx){
        return list[idx] || at(idx - list.length);
      }
    }

    function style(el){
      return R.reduce(function(memo, assign){
        if (!assign) return memo;
        var pair = assign.split(":");
        memo[pair[0].trim()] = pair[1].trim();
        return memo;
      }, {}, (el.attr("style") || "").split(";"));
    }

    function extractStyle(el){
      var css = style(el);
      el.attr("style", null);
      return css;
    }

    var regionNames = ["aceh", "sumatera-utara", "rian", "sumatera-barat", "sumatera-selatan", "java-temur", "halmahera", "benakulu", "lampung", "bali", "jambi", "jawa-barat", "java-tengah", "musa-tenggara-barat", "musa-tenggara-timur", "maluku", "papua", "sulawesi-utara", "sulawesi-tengah", "sulawesi-tenggara", "sulawesi-salatan", "kalimatan-salatan", "kalimatan-tengah", "kalimatan-barat", "kalimatan-timur", "sarawak"];
    var goodsNames  = ["spice", "shipped-spice", "rice", "shipped-rice", "siap-faji", "shipped-siap-faji", "rubber", "shipped-rubber", "oil", "shipped-oil"];

    $(function(){
      $("#indonesia").load(function(){
        var board   = $(this.contentDocument);
        var layers  = {regions: board.find("#layer7"), oceans: board.find("#layer2").remove(), arrows: board.find("#layer5").remove()};
        var goods   = getElements(piece(board) , goodsNames);
        var regions = getElements(pieces(board), regionNames);
        var tile = cycles(goodsNames);
        $.each(regions, function(name, region){
          $.each(region, function(idx, spot){
            spot.attr(R.pick(['fill', 'stroke'], extractStyle(spot)));
            addPiece(spot, '#' + tile(idx)).appendTo(layers.regions);
            var orig = spot.attr("fill"), other = "#bb625e", dim = "#333";
            var over = s.animate({attributeName: "fill", fill: "freeze", begin: 'mouseover', dur: "1s", from: orig, to: other}).appendTo(spot);
            var out  = s.animate({attributeName: "fill", fill: "freeze", begin: 'mouseout' , dur: ".5s", from: other, to: orig}).appendTo(spot);
            spot.on("mouseover", function(){
              console.log("mouseover", piece);
            });
            spot.on("click", R.once(function(){
              over.attr("from", dim);
              out.attr("to", dim);
            }));
          });
        });
        $.extend(s, {board: board, layers: layers, regions: regions, goods: goods});
      });
    });

  </script>
</head>
<body>
  <object id="indonesia" type="image/svg+xml" data="map/indonesia.svg">No SVG support</object>
</body>
</html>
