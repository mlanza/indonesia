<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Indonesia</title>
  <script src="jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="ramda.js" type="text/javascript" charset="utf-8"></script>
  <script>

    var s = (function(){
      var svgns = "http://www.w3.org/2000/svg";

      function tag(name, ns){
        ns || (ns = {});
        return function(attrs){
          var el = document.createElementNS(svgns, name);
          $.each(attrs, function(key, value){
            ns[key] ? el.setAttributeNS(ns[key], key, value) : el.setAttribute(key, value);
          });
          return $(el);
        }
      }

      function bbox(el){
        return el.get(0).getBBox();
      }

      function coord(el){
        var b = bbox(el);
        return {x: b.x, y: b.y};
      }

      function center(el){
        var b = bbox(el);
        return {x: b.x + (b.width / 2), y: b.y + (b.height / 2)};
      }

      return {
        bbox:   bbox,
        center: center,
        coord:  coord,
        rect:   tag('rect'),
        circle: tag('circle'),
        use:    tag('use', {href: "http://www.w3.org/1999/xlink"})
      }
    })(), use = s.use;

    function getParts(el, name, upper){
      return R.reduce(function(list, n){
        var piece = '#' + name + '-' + n;
        var part = el.find(piece);
        return part.length > 0 ? list.concat([part]) : list;
      }, [], R.range(1, (upper || 10) + 1));
    }

    function getRegions(el, regions){
      return R.reduce(function(dict, name){
        dict[name] = getParts(el, name);
        return dict;
      }, {}, regions);
    }

    function addPiece(el, id){
      var offset = 17.5;
      var c = s.center(el), x = c.x - offset, y = c.y - offset;
      return use({x: x, y: y, href: '#' + id});
    }

    $(function(){
      $("#indonesia").load(function(){
        var board   = $(this.contentDocument);
        var regions = board.find("#layer7");
        var oceans  = board.find("#layer2").remove();
        var arrows  = board.find("#layer5").remove();
        var spice   = board.find("#spice");
        var locations = getRegions(regions, ["aceh", "sumatera-utara", "rian", "sumatera-barat", "sumatera-selatan", "java-temur", "halmahera", "benakulu", "lampung", "bali", "jambi", "jawa-barat", "java-tengah", "musa-tenggara-barat", "musa-tenggara-timur", "maluku", "papua", "sulawesi-utara", "sulawesi-tengah", "sulawesi-tenggara", "sulawesi-salatan", "kalimatan-salatan", "kalimatan-tengah", "kalimatan-barat", "kalimatan-timur", "sarawak"])
        var respice = use({href: '#spice', x: 0, y: 0}).appendTo(regions);
        $.each(locations, function(name, area){
          $.each(area, function(idx, loc){
            addPiece(loc, 'spice').appendTo(regions);
          });
        });
        $.extend(s, {board: board, regions: regions, locations: locations, spice: spice, respice: respice});
      });
    });

  </script>
</head>
<body>
  <object id="indonesia" type="image/svg+xml" data="map/indonesia.svg">No SVG support</object>
</body>
</html>
